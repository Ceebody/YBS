<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yeriel Bracha Computing Quiz</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #ff7b00 0%, #ff9500 50%, #ffb347 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      width: 90%;
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 2.2em;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    h2 {
      color: #34495e;
      margin-bottom: 20px;
      font-size: 1.3em;
      text-align: center;
    }
    
    .hidden { 
      display: none; 
    }
    
    /* Name Input Page */
    .name-section {
      text-align: center;
      padding: 20px;
    }
    
    .name-section p {
      font-size: 1.1em;
      color: #555;
      margin-bottom: 20px;
    }
    
    input[type="text"] {
      width: 100%;
      max-width: 400px;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #bdc3c7;
      font-size: 1.1em;
      margin: 15px auto;
      display: block;
      transition: border-color 0.3s ease;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #ff7b00;
      box-shadow: 0 0 0 3px rgba(255, 123, 0, 0.1);
    }
    
    /* Welcome Page */
    .welcome-content {
      text-align: center;
      padding: 20px;
    }
    
    .quiz-info {
      background: rgba(255, 123, 0, 0.1);
      border: 2px solid #ff7b00;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .quiz-info p {
      margin: 10px 0;
      font-size: 1.1em;
      color: #2c3e50;
    }
    
    marquee {
      background: linear-gradient(135deg, #ff7b00, #ff9500);
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: bold;
    }
    
    /* Buttons */
    button {
      background: linear-gradient(135deg, #ff7b00, #ff9500);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 600;
      margin: 10px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    button:hover {
      background: linear-gradient(135deg, #ff9500, #ff7b00);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 123, 0, 0.4);
    }
    
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    button.secondary {
      background: #ecf0f1;
      color: #2c3e50;
      text-transform: none;
      letter-spacing: normal;
      padding: 12px 20px;
      margin: 5px;
      border-radius: 10px;
      font-weight: normal;
    }
    
    button.secondary:hover {
      background: #bdc3c7;
      transform: translateY(-1px);
    }
    
    button.selected {
      background: linear-gradient(135deg, #27ae60, #2ecc71) !important;
      color: white !important;
    }
    
    /* Countdown Screen */
    .countdown-screen {
      text-align: center;
      padding: 60px 20px;
      font-size: 4em;
      font-weight: bold;
      color: #ff7b00;
      animation: pulse 1s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.1); opacity: 1; }
    }
    
    /* Quiz Area */
    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 15px;
      background: rgba(255, 123, 0, 0.1);
      border-radius: 10px;
    }
    
    .question-counter {
      font-weight: bold;
      color: #2c3e50;
      font-size: 1.1em;
    }
    
    .timer {
      font-weight: bold;
      color: #e74c3c;
      font-size: 1.2em;
      padding: 8px 15px;
      background: rgba(231, 76, 60, 0.1);
      border-radius: 20px;
    }
    
    .timer.warning {
      animation: blink 1s infinite;
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.5; }
    }
    
    .question-content {
      background: rgba(255, 255, 255, 0.8);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      border-left: 5px solid #ff7b00;
    }
    
    .question-text {
      font-size: 1.2em;
      color: #2c3e50;
      font-weight: 600;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    
    .options-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 25px;
    }
    
    .option-button {
      text-align: left;
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 1em;
      line-height: 1.4;
      word-wrap: break-word;
    }
    
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    
    /* Results */
    .results {
      padding: 20px;
      text-align: center;
    }
    
    .score-display {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin: 20px 0;
      font-size: 1.3em;
    }
    
    .summary {
      text-align: left;
      margin-top: 30px;
      padding: 20px;
      background: rgba(236, 240, 241, 0.8);
      border-radius: 15px;
    }
    
    .summary h3 {
      color: #2c3e50;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.4em;
    }
    
    .question-review {
      margin: 15px 0;
      padding: 15px;
      background: white;
      border-radius: 10px;
      border-left: 4px solid #bdc3c7;
    }
    
    .question-review.correct {
      border-left-color: #27ae60;
    }
    
    .question-review.wrong {
      border-left-color: #e74c3c;
    }
    
    .correct { 
      color: #27ae60; 
      font-weight: bold; 
    }
    
    .wrong { 
      color: #e74c3c; 
      font-weight: bold; 
    }
    
    /* Footer */
    footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      border-radius: 15px;
      font-size: 14px;
    }
    
    /* Lock Message */
    .lock-message {
      text-align: center;
      color: #e74c3c;
      font-weight: bold;
      background: rgba(231, 76, 60, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
        width: calc(100% - 20px);
      }
      
      h1 {
        font-size: 1.8em;
      }
      
      .countdown-screen {
        font-size: 3em;
        padding: 40px 20px;
      }
      
      .quiz-header {
        flex-direction: column;
        gap: 10px;
      }
      
      .controls {
        flex-direction: column;
        gap: 15px;
      }
      
      .nav-buttons {
        width: 100%;
        justify-content: space-between;
      }
      
      button {
        padding: 12px 20px;
        font-size: 1em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Name Input Page -->
    <div id="namePage" class="name-section">
      <h1>üéì Yeriel Bracha Computing Quiz</h1>
      <p>Welcome! Please enter your full name to begin the quiz.</p>
      <input type="text" id="studentName" placeholder="Enter your full name" />
      <button id="proceedBtn">Proceed to Quiz</button>
      <div id="lockMessage" class="lock-message hidden"></div>
    </div>

    <!-- Welcome Page -->
    <div id="welcomePage" class="welcome-content hidden">
      <h1>Welcome to Quizzilla! üöÄ</h1>
      <div class="quiz-info">
        <p>üìö <strong>Subject:</strong> Introduction to Computing</p>
        <marquee>Just select the correct answer for each question!</marquee>
        <p>‚è±Ô∏è <strong>Time Limit:</strong> 30 minutes</p>
        <p>‚ùì <strong>Questions:</strong> 40 questions (all questions included)</p>
        <p>üéØ <strong>Instructions:</strong> Use Next and Previous to navigate, click Submit when done</p>
      </div>
      <button id="startBtn">üéØ Sure, Let's Start Quiz!</button>
    </div>

    <!-- Countdown Screen -->
    <div id="countdownScreen" class="countdown-screen hidden"></div>

    <!-- Quiz Area -->
    <div id="quizArea" class="hidden">
      <div class="quiz-header">
        <div class="question-counter" id="questionCounter">Question 1 of 40</div>
        <div class="timer" id="timer">30:00</div>
      </div>
      
      <div class="question-content">
        <div class="question-text" id="questionText"></div>
        <div class="options-grid" id="optionsContainer"></div>
      </div>
      
      <div class="controls">
        <div class="nav-buttons">
          <button type="button" id="prevBtn" class="secondary">‚Üê Previous</button>
          <button type="button" id="nextBtn">Next ‚Üí</button>
        </div>
        <button type="button" id="submitBtn" class="hidden">üéØ Submit Quiz</button>
      </div>
    </div>

    <!-- Results Area -->
    <div id="resultsArea" class="results hidden">
      <h1>üéâ Quiz Completed!</h1>
      <div id="scoreDisplay" class="score-display"></div>
      <div id="summaryContainer" class="summary"></div>
    </div>

    <!-- Footer -->
    <footer>
      <p><strong>Yeriel Bracha Coding Club</strong><br>¬© 2025 - Excellence in Computing Education</p>
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCY9oturc9bql33PSUkfNUptcHXla2RWN4",
      authDomain: "tracha-xx.firebaseapp.com",
      databaseURL: "https://tracha-xx-default-rtdb.firebaseio.com",
      projectId: "tracha-xx",
      storageBucket: "tracha-xx.appspot.com",
      messagingSenderId: "914440906583",
      appId: "1:914440906583:web:123abc456xyz"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Quiz Configuration - Updated for all 40 questions
    const QUIZ_DURATION = 30 * 60; // 30 minutes in seconds
    const TOTAL_QUESTIONS = 40; // Show all 40 questions
    const COOLDOWN_HOURS = 12;

    // Quiz Data - All 40 questions
    const allQuestions = [
      {
        q: "1. Early scientists built the first generation computers mainly for which reason?",
        options: [
          "To play music and movies",
          "To solve scientific and military problems",
          "To design games for children",
          "To teach typing in schools"
        ],
        answer: "To solve scientific and military problems"
      },
      {
        q: "2. The fourth generation of computers became faster because they used ________.",
        options: ["Vacuum tubes", "Microprocessors", "Transistors", "Magnetic tapes"],
        answer: "Microprocessors"
      },
      {
        q: "3. When comparing first and fifth generation computers, which feature shows the greatest change?",
        options: [
          "Colour of the monitor",
          "Speed and size of the processor",
          "Number of keys on the keyboard",
          "Shape of the mouse"
        ],
        answer: "Speed and size of the processor"
      },
      {
        q: "4. A student wants to prepare charts using data. Which computer component will process her data into information?",
        options: ["CPU", "Monitor", "Keyboard", "Printer"],
        answer: "CPU"
      },
      {
        q: "5. Which part of the computer is best described as its 'brain' because it carries out instructions?",
        options: ["CPU", "RAM", "Monitor", "Keyboard"],
        answer: "CPU"
      },
      {
        q: "6. When a computer user moves the mouse, which item on the screen also moves?",
        options: ["Cursor", "Icon", "Window", "Folder"],
        answer: "Cursor"
      },
      {
        q: "7. The scroll wheel on a mouse helps a user to ________.",
        options: [
          "Turn on the computer",
          "Move up and down long pages easily",
          "Save documents automatically",
          "Switch between computers"
        ],
        answer: "Move up and down long pages easily"
      },
      {
        q: "8. Which of these shows the correct flow of data in a computer system?",
        options: [
          "Input ‚Üí Processing ‚Üí Output",
          "Output ‚Üí Input ‚Üí Processing",
          "Processing ‚Üí Output ‚Üí Input",
          "Input ‚Üí Output ‚Üí Processing"
        ],
        answer: "Input ‚Üí Processing ‚Üí Output"
      },
      {
        q: "9. If a computer shows no picture but the power light is on, which part may be faulty?",
        options: ["Monitor", "Keyboard", "Mouse", "Speaker"],
        answer: "Monitor"
      },
      {
        q: "10. The RAM in a computer is used to ________.",
        options: [
          "Store temporary data while the computer is working",
          "Store pictures permanently",
          "Control external devices",
          "Print text on paper"
        ],
        answer: "Store temporary data while the computer is working"
      },
      {
        q: "11. The physical parts of a computer that can be touched are known as ________.",
        options: ["Hardware", "Software", "Data", "Applications"],
        answer: "Hardware"
      },
      {
        q: "12. Which of the following groups contains only input devices?",
        options: [
          "Mouse, Keyboard, Scanner",
          "Printer, Monitor, CPU",
          "Speaker, Microphone, Mouse",
          "Flash drive, Keyboard, Monitor"
        ],
        answer: "Mouse, Keyboard, Scanner"
      },
      {
        q: "13. The main function of output devices is to ________.",
        options: [
          "Send results from the computer to the user",
          "Store information permanently",
          "Type commands into the computer",
          "Transfer data between computers"
        ],
        answer: "Send results from the computer to the user"
      },
      {
        q: "14. A learner inserted a flash drive to copy pictures. What type of device is the flash drive?",
        options: ["Storage", "Input", "Output", "Processing"],
        answer: "Storage"
      },
      {
        q: "15. The small pictures that represent files or programs on the desktop are called ________.",
        options: ["Icons", "Windows", "Folders", "Pointers"],
        answer: "Icons"
      },
      {
        q: "16. Which desktop action helps to open a shortcut menu for quick commands?",
        options: [
          "Left-click",
          "Double-click",
          "Right-click",
          "Scroll up"
        ],
        answer: "Right-click"
      },
      {
        q: "17. Why is organizing files into folders important?",
        options: [
          "It keeps the desktop neat and helps locate files quickly",
          "It makes the computer look colourful",
          "It deletes old files automatically",
          "It prevents viruses"
        ],
        answer: "It keeps the desktop neat and helps locate files quickly"
      },
      {
        q: "18. The Recycle Bin is useful because it allows the user to ________.",
        options: [
          "Recover deleted files",
          "Install new programs",
          "Store music permanently",
          "Print documents faster"
        ],
        answer: "Recover deleted files"
      },
      {
        q: "19. The third generation of computers replaced transistors with ________.",
        options: ["Integrated circuits", "Vacuum tubes", "Microprocessors", "Magnetic tapes"],
        answer: "Integrated circuits"
      },
      {
        q: "20. The combination of monitor, CPU, mouse, and keyboard makes up the ________.",
        options: ["Computer system", "Input unit", "Output unit", "Software group"],
        answer: "Computer system"
      },
      {
        q: "21. Why was the invention of the microprocessor an important step in computing history?",
        options: [
          "It made computers smaller and faster",
          "It increased electricity consumption",
          "It removed the need for software",
          "It stopped computers from using memory"
        ],
        answer: "It made computers smaller and faster"
      },
      {
        q: "22. Which device allows a user to speak to the computer during recording?",
        options: ["Microphone", "Speaker", "Printer", "Mouse"],
        answer: "Microphone"
      },
      {
        q: "23. When a student right-clicks the desktop and selects 'Personalize', what is the purpose?",
        options: [
          "To change or set the desktop background",
          "To delete all folders",
          "To open a new program",
          "To restart the computer"
        ],
        answer: "To change or set the desktop background"
      },
      {
        q: "24. If you rename a folder incorrectly, what is the best way to correct the name?",
        options: [
          "Right-click and choose Rename again",
          "Delete and create a new folder",
          "Turn off the computer",
          "Drag the folder to Recycle Bin"
        ],
        answer: "Right-click and choose Rename again"
      },
      {
        q: "25. The storage device that uses magnetic plates to store large amounts of data is called ________.",
        options: ["Hard disk", "Flash drive", "CD-ROM", "DVD"],
        answer: "Hard disk"
      },
      {
        q: "26. Which group of devices belongs to the fourth generation of computers?",
        options: [
          "Vacuum tubes",
          "Transistors",
          "Microprocessors",
          "Integrated circuits"
        ],
        answer: "Microprocessors"
      },
      {
        q: "27. A computer with touch screen input is an example of combining which two functions?",
        options: [
          "Input and Output",
          "Storage and Processing",
          "Output and Power supply",
          "Input and Storage"
        ],
        answer: "Input and Output"
      },
      {
        q: "28. When you double-click an icon, what usually happens?",
        options: [
          "The related program or file opens",
          "The icon is deleted",
          "The background changes",
          "The computer shuts down"
        ],
        answer: "The related program or file opens"
      },
      {
        q: "29. Which part of the computer stores programs and data permanently even when power is off?",
        options: ["Hard disk", "RAM", "Cache", "Processor"],
        answer: "Hard disk"
      },
      {
        q: "30. Why do modern computers consume less power than early computers?",
        options: [
          "They use efficient microprocessors instead of vacuum tubes",
          "They use more lights and fans",
          "They have larger screens",
          "They store more information"
        ],
        answer: "They use efficient microprocessors instead of vacuum tubes"
      },
      {
        q: "31. The purpose of an operating system is to ________.",
        options: [
          "Control how the computer's hardware and software work together",
          "Print documents automatically",
          "Display pictures only",
          "Replace the keyboard"
        ],
        answer: "Control how the computer's hardware and software work together"
      },
      {
        q: "32. Which of these is the correct order from earliest to latest computer generation?",
        options: [
          "Vacuum tubes ‚Üí Transistors ‚Üí Integrated circuits ‚Üí Microprocessors",
          "Microprocessors ‚Üí Transistors ‚Üí Integrated circuits ‚Üí Vacuum tubes",
          "Transistors ‚Üí Microprocessors ‚Üí Vacuum tubes ‚Üí Integrated circuits",
          "Integrated circuits ‚Üí Vacuum tubes ‚Üí Transistors ‚Üí Microprocessors"
        ],
        answer: "Vacuum tubes ‚Üí Transistors ‚Üí Integrated circuits ‚Üí Microprocessors"
      },
      {
        q: "33. A student wants to move an icon from one side of the desktop to another. Which mouse action should be used?",
        options: ["Click and drag", "Right-click", "Double-click", "Scroll"],
        answer: "Click and drag"
      },
      {
        q: "34. If a printer is connected but does not print, which step should come first?",
        options: [
          "Check if the printer is powered on",
          "Replace the mouse",
          "Restart the computer",
          "Change the desktop background"
        ],
        answer: "Check if the printer is powered on"
      },
      {
        q: "35. Which component temporarily holds data that the CPU is currently using?",
        options: ["RAM", "Hard disk", "Monitor", "Cache"],
        answer: "RAM"
      },
      {
        q: "36. What is the main difference between hardware and software?",
        options: [
          "Hardware can be touched; software cannot",
          "Software is heavier than hardware",
          "Hardware is always faster than software",
          "Software is made of metal"
        ],
        answer: "Hardware can be touched; software cannot"
      },
      {
        q: "37. The unit that controls all other parts of the computer is the ________.",
        options: ["Control Unit", "Mouse", "Monitor", "Memory Unit"],
        answer: "Control Unit"
      },
      {
        q: "38. Which device changes digital documents into printed form?",
        options: ["Printer", "Scanner", "Camera", "Speaker"],
        answer: "Printer"
      },
      {
        q: "39. Which of the following activities mainly uses an output device?",
        options: [
          "Displaying a chart on the screen",
          "Typing with a keyboard",
          "Recording a song with a microphone",
          "Saving files to a flash drive"
        ],
        answer: "Displaying a chart on the screen"
      },
      {
        q: "40. A learner wants to create a personal folder for saving homework. Which is the correct sequence of steps?",
        options: [
          "Right-click desktop ‚Üí New ‚Üí Folder ‚Üí Name it",
          "Click Start ‚Üí Delete ‚Üí Folder",
          "Open Recycle Bin ‚Üí New ‚Üí File",
          "Press Enter ‚Üí Right-click ‚Üí Print"
        ],
        answer: "Right-click desktop ‚Üí New ‚Üí Folder ‚Üí Name it"
      }
    ];

    // Global Variables
    let studentName = "";
    let currentQuestion = 0;
    let selectedQuestions = [];
    let userAnswers = [];
    let quizTimer;
    let timeRemaining = QUIZ_DURATION;
    let quizStarted = false;

    // DOM Elements
    const namePage = document.getElementById("namePage");
    const welcomePage = document.getElementById("welcomePage");
    const countdownScreen = document.getElementById("countdownScreen");
    const quizArea = document.getElementById("quizArea");
    const resultsArea = document.getElementById("resultsArea");
    const lockMessage = document.getElementById("lockMessage");

    // Quiz Elements
    const questionCounter = document.getElementById("questionCounter");
    const timer = document.getElementById("timer");
    const questionText = document.getElementById("questionText");
    const optionsContainer = document.getElementById("optionsContainer");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");

    // Results Elements
    const scoreDisplay = document.getElementById("scoreDisplay");
    const summaryContainer = document.getElementById("summaryContainer");

    // Utility Functions
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    // Check Student Eligibility
    async function checkStudentEligibility(name) {
      try {
        const studentRef = ref(db, `quizResults`);
        const snapshot = await get(studentRef);
        
        if (!snapshot.exists()) {
          return { canTake: true };
        }

        const allScores = snapshot.val();
        const studentScores = Object.values(allScores).filter(score => 
          score.name && score.name.toLowerCase() === name.toLowerCase()
        );

        if (studentScores.length === 0) {
          return { canTake: true };
        }

        // Find most recent submission
        const lastSubmission = studentScores.sort((a, b) => 
          new Date(b.date) - new Date(a.date)
        )[0];

        const lastSubmissionTime = new Date(lastSubmission.date);
        const now = new Date();
        const timeDiff = now - lastSubmissionTime;
        const hoursDiff = timeDiff / (1000 * 60 * 60);

        if (hoursDiff < COOLDOWN_HOURS) {
          const remainingTime = (COOLDOWN_HOURS * 60 * 60 * 1000) - timeDiff;
          return { 
            canTake: false, 
            remainingTime: remainingTime,
            lastScore: lastSubmission.total || 0,
            lastPercentage: Math.round((lastSubmission.total || 0) / 40 * 100)
          };
        }

        return { canTake: true };
      } catch (error) {
        console.error("Error checking eligibility:", error);
        return { canTake: true };
      }
    }

    // Event Listeners
    document.getElementById("proceedBtn").addEventListener("click", async () => {
      const nameInput = document.getElementById("studentName").value.trim();
      if (!nameInput) {
        alert("Please enter your name before proceeding!");
        return;
      }
      
      studentName = nameInput;
      const eligibility = await checkStudentEligibility(studentName);
      
      if (!eligibility.canTake) {
        const hours = Math.floor(eligibility.remainingTime / (1000 * 60 * 60));
        const minutes = Math.floor((eligibility.remainingTime % (1000 * 60 * 60)) / (1000 * 60));
        
        lockMessage.classList.remove("hidden");
        lockMessage.innerHTML = `
          <p>‚è∞ You have already completed this quiz recently.</p>
          <p>Last Score: ${eligibility.lastScore}/40 (${eligibility.lastPercentage}%)</p>
          <p>You can try again in: ${hours}h ${minutes}m</p>
        `;
        return;
      }

      namePage.classList.add("hidden");
      welcomePage.classList.remove("hidden");
    });

    document.getElementById("startBtn").addEventListener("click", () => {
      welcomePage.classList.add("hidden");
      startCountdown();
    });

    // Countdown Function
    function startCountdown() {
      countdownScreen.classList.remove("hidden");
      let counter = 3;
      countdownScreen.textContent = `Get Ready... ${counter}`;

      const countdown = setInterval(() => {
        counter--;
        if (counter > 0) {
          countdownScreen.textContent = `${counter}...`;
        } else {
          clearInterval(countdown);
          countdownScreen.textContent = "Begin!";
          setTimeout(() => {
            countdownScreen.classList.add("hidden");
            initializeQuiz();
          }, 800);
        }
      }, 1000);
    }

    // Initialize Quiz
    function initializeQuiz() {
      // Use all 40 questions in order
      selectedQuestions = [...allQuestions];
      userAnswers = new Array(TOTAL_QUESTIONS).fill(null);
      currentQuestion = 0;
      quizStarted = true;
      
      quizArea.classList.remove("hidden");
      loadQuestion();
      startTimer();
      
      // Prevent page refresh
      window.addEventListener('beforeunload', function (e) {
        if (quizStarted) {
          e.preventDefault();
          e.returnValue = '';
        }
      });
    }

    // Load Question
    function loadQuestion() {
      const question = selectedQuestions[currentQuestion];
      
      // Update counter
      questionCounter.textContent = `Question ${currentQuestion + 1} of ${TOTAL_QUESTIONS}`;
      
      // Update question text
      questionText.textContent = question.q;
      
      // Clear and populate options
      optionsContainer.innerHTML = "";
      question.options.forEach((option, index) => {
        const button = document.createElement("button");
        button.className = "option-button secondary";
        button.textContent = option;
        
        if (userAnswers[currentQuestion] === option) {
          button.classList.add("selected");
        }
        
        button.addEventListener("click", () => selectAnswer(option));
        optionsContainer.appendChild(button);
      });
      
      // Update navigation buttons
      prevBtn.disabled = currentQuestion === 0;
      
      if (currentQuestion === TOTAL_QUESTIONS - 1) {
        nextBtn.classList.add("hidden");
        submitBtn.classList.remove("hidden");
      } else {
        nextBtn.classList.remove("hidden");
        submitBtn.classList.add("hidden");
      }
    }

    // Select Answer
    function selectAnswer(answer) {
      userAnswers[currentQuestion] = answer;
      loadQuestion(); // Refresh to show selection
    }

    // Navigation
    prevBtn.addEventListener("click", () => {
      if (currentQuestion > 0) {
        currentQuestion--;
        loadQuestion();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentQuestion < TOTAL_QUESTIONS - 1) {
        currentQuestion++;
        loadQuestion();
      }
    });

    submitBtn.addEventListener("click", () => {
      if (confirm("Are you sure you want to submit your quiz? You cannot change answers after submission.")) {
        finishQuiz();
      }
    });

    // Timer Functions
    function startTimer() {
      updateTimerDisplay();
      quizTimer = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        
        if (timeRemaining <= 0) {
          clearInterval(quizTimer);
          autoSubmitQuiz();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      timer.textContent = formatTime(timeRemaining);
      
      // Add warning class for last 5 minutes
      if (timeRemaining <= 300) {
        timer.classList.add("warning");
      }
    }

    function stopTimer() {
      if (quizTimer) {
        clearInterval(quizTimer);
      }
    }

    // Auto Submit
    function autoSubmitQuiz() {
      alert("Time's up! Your quiz will be submitted automatically.");
      finishQuiz(true);
    }

    // Finish Quiz
    async function finishQuiz(isAutoSubmit = false) {
      quizStarted = false;
      stopTimer();
      
      quizArea.classList.add("hidden");
      resultsArea.classList.remove("hidden");
      
      // Calculate score
      let correctAnswers = 0;
      const reviewHTML = [];
      
      selectedQuestions.forEach((question, index) => {
        const userAnswer = userAnswers[index] || "(No answer)";
        const isCorrect = userAnswer === question.answer;
        
        if (isCorrect) correctAnswers++;
        
        reviewHTML.push(`
          <div class="question-review ${isCorrect ? 'correct' : 'wrong'}">
            <p><strong>Q${index + 1}:</strong> ${question.q}</p>
            <p>Your answer: <span class="${isCorrect ? 'correct' : 'wrong'}">${userAnswer}</span></p>
            <p>Correct answer: <span class="correct">${question.answer}</span></p>
          </div>
        `);
      });
      
      const percentage = Math.round((correctAnswers / TOTAL_QUESTIONS) * 100);
      const timeUsed = QUIZ_DURATION - timeRemaining;
      
      // Display results
      scoreDisplay.innerHTML = `
        <h2>üìä Your Results</h2>
        <p><strong>Student:</strong> ${studentName}</p>
        <p><strong>Score:</strong> ${correctAnswers} / ${TOTAL_QUESTIONS} (${percentage}%)</p>
        <p><strong>Time Used:</strong> ${formatTime(timeUsed)}</p>
        ${isAutoSubmit ? '<p><strong>Status:</strong> Auto-submitted (Time expired)</p>' : ''}
        <p><strong>Grade:</strong> ${percentage >= 70 ? 'üéâ Excellent!' : percentage >= 50 ? 'üëç Good!' : 'üìö Keep studying!'}</p>
      `;
      
      summaryContainer.innerHTML = `
        <h3>üìã Detailed Review</h3>
        ${reviewHTML.join('')}
      `;
      
      // Save to Firebase - Using quizResults path for admin dashboard compatibility
      try {
        const newRef = push(ref(db, "quizResults"));
        
        await set(newRef, {
          name: studentName,
          sectionA: correctAnswers, // For compatibility with admin dashboard
          sectionB: 0, // For compatibility with admin dashboard  
          total: correctAnswers,
          percentage: percentage,
          timeUsed: timeUsed,
          autoSubmitted: isAutoSubmit,
          date: new Date().toLocaleString(),
          timestamp: new Date().toISOString(),
          subject: "Introduction to Computing"
        });
        
        // Show success message
        const successDiv = document.createElement('div');
        successDiv.style.cssText = `
          background: rgba(40, 167, 69, 0.9);
          color: white;
          padding: 15px;
          border-radius: 10px;
          margin-top: 20px;
          text-align: center;
          font-weight: 600;
        `;
        successDiv.innerHTML = `‚úÖ Score saved successfully!<br>‚è∞ You can retake this quiz after ${COOLDOWN_HOURS} hours.`;
        resultsArea.appendChild(successDiv);
        
      } catch (error) {
        console.error("Error saving results:", error);
        
        // Show error message
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
          background: rgba(220, 53, 69, 0.9);
          color: white;
          padding: 15px;
          border-radius: 10px;
          margin-top: 20px;
          text-align: center;
          font-weight: 600;
        `;
        errorDiv.innerHTML = '‚ö†Ô∏è Quiz completed but could not save to database. Please contact your instructor.';
        resultsArea.appendChild(errorDiv);
      }
    }
  </script>
</body>
</html>
