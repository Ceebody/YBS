<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yeriel Bracha Computing Quiz</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #ff7b00 0%, #ff9500 50%, #ffb347 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      width: 90%;
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 2.2em;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    h2 {
      color: #34495e;
      margin-bottom: 20px;
      font-size: 1.3em;
      text-align: center;
    }
    
    .hidden { 
      display: none; 
    }
    
    /* Name Input Page */
    .name-section {
      text-align: center;
      padding: 20px;
    }
    
    .name-section p {
      font-size: 1.1em;
      color: #555;
      margin-bottom: 20px;
    }
    
    input[type="text"] {
      width: 100%;
      max-width: 400px;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #bdc3c7;
      font-size: 1.1em;
      margin: 15px auto;
      display: block;
      transition: border-color 0.3s ease;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #ff7b00;
      box-shadow: 0 0 0 3px rgba(255, 123, 0, 0.1);
    }
    
    /* Welcome Page */
    .welcome-content {
      text-align: center;
      padding: 20px;
    }
    
    .quiz-info {
      background: rgba(255, 123, 0, 0.1);
      border: 2px solid #ff7b00;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .quiz-info p {
      margin: 10px 0;
      font-size: 1.1em;
      color: #2c3e50;
    }
    
    marquee {
      background: linear-gradient(135deg, #ff7b00, #ff9500);
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: bold;
    }
    
    /* Buttons */
    button {
      background: linear-gradient(135deg, #ff7b00, #ff9500);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 600;
      margin: 10px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    button:hover {
      background: linear-gradient(135deg, #ff9500, #ff7b00);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 123, 0, 0.4);
    }
    
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    button.secondary {
      background: #ecf0f1;
      color: #2c3e50;
      text-transform: none;
      letter-spacing: normal;
      padding: 12px 20px;
      margin: 5px;
      border-radius: 10px;
      font-weight: normal;
    }
    
    button.secondary:hover {
      background: #bdc3c7;
      transform: translateY(-1px);
    }
    
    button.selected {
      background: linear-gradient(135deg, #27ae60, #2ecc71) !important;
      color: white !important;
    }
    
    /* Countdown Screen */
    .countdown-screen {
      text-align: center;
      padding: 60px 20px;
      font-size: 4em;
      font-weight: bold;
      color: #ff7b00;
      animation: pulse 1s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.1); opacity: 1; }
    }
    
    /* Quiz Area */
    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 15px;
      background: rgba(255, 123, 0, 0.1);
      border-radius: 10px;
    }
    
    .question-counter {
      font-weight: bold;
      color: #2c3e50;
      font-size: 1.1em;
    }
    
    .timer {
      font-weight: bold;
      color: #e74c3c;
      font-size: 1.2em;
      padding: 8px 15px;
      background: rgba(231, 76, 60, 0.1);
      border-radius: 20px;
    }
    
    .timer.warning {
      animation: blink 1s infinite;
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.5; }
    }
    
    .question-content {
      background: rgba(255, 255, 255, 0.8);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      border-left: 5px solid #ff7b00;
    }
    
    .question-text {
      font-size: 1.2em;
      color: #2c3e50;
      font-weight: 600;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    
    .options-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 25px;
    }
    
    .option-button {
      text-align: left;
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 1em;
      line-height: 1.4;
      word-wrap: break-word;
    }
    
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    
    /* Results */
    .results {
      padding: 20px;
      text-align: center;
    }
    
    .score-display {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin: 20px 0;
      font-size: 1.3em;
    }
    
    .summary {
      text-align: left;
      margin-top: 30px;
      padding: 20px;
      background: rgba(236, 240, 241, 0.8);
      border-radius: 15px;
    }
    
    .summary h3 {
      color: #2c3e50;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.4em;
    }
    
    .question-review {
      margin: 15px 0;
      padding: 15px;
      background: white;
      border-radius: 10px;
      border-left: 4px solid #bdc3c7;
    }
    
    .question-review.correct {
      border-left-color: #27ae60;
    }
    
    .question-review.wrong {
      border-left-color: #e74c3c;
    }
    
    .correct { 
      color: #27ae60; 
      font-weight: bold; 
    }
    
    .wrong { 
      color: #e74c3c; 
      font-weight: bold; 
    }
    
    /* Footer */
    footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      border-radius: 15px;
      font-size: 14px;
    }
    
    /* Lock Message */
    .lock-message {
      text-align: center;
      color: #e74c3c;
      font-weight: bold;
      background: rgba(231, 76, 60, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
        width: calc(100% - 20px);
      }
      
      h1 {
        font-size: 1.8em;
      }
      
      .countdown-screen {
        font-size: 3em;
        padding: 40px 20px;
      }
      
      .quiz-header {
        flex-direction: column;
        gap: 10px;
      }
      
      .controls {
        flex-direction: column;
        gap: 15px;
      }
      
      .nav-buttons {
        width: 100%;
        justify-content: space-between;
      }
      
      button {
        padding: 12px 20px;
        font-size: 1em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Name Input Page -->
    <div id="namePage" class="name-section">
      <h1>üéì Yeriel Bracha Computing Quiz</h1>
      <p>Welcome! Please enter your full name to begin the quiz.</p>
      <input type="text" id="studentName" placeholder="Enter your full name" />
      <button id="proceedBtn">Proceed to Quiz</button>
      <div id="lockMessage" class="lock-message hidden"></div>
    </div>

    <!-- Welcome Page -->
    <div id="welcomePage" class="welcome-content hidden">
      <h1>Welcome to Quizzilla! üöÄ</h1>
      <div class="quiz-info">
        <p>üìö <strong>Subject:</strong> Introduction to Computing</p>
        <marquee>Just select the correct answer for each question!</marquee>
        <p>‚è±Ô∏è <strong>Time Limit:</strong> 30 minutes</p>
        <p>‚ùì <strong>Questions:</strong> 30 questions (from 40 available)</p>
        <p>üéØ <strong>Instructions:</strong> Use Next and Previous to navigate, click Submit when done</p>
      </div>
      <button id="startBtn">üéØ Sure, Let's Start Quiz!</button>
    </div>

    <!-- Countdown Screen -->
    <div id="countdownScreen" class="countdown-screen hidden"></div>

    <!-- Quiz Area -->
    <div id="quizArea" class="hidden">
      <div class="quiz-header">
        <div class="question-counter" id="questionCounter">Question 1 of 30</div>
        <div class="timer" id="timer">30:00</div>
      </div>
      
      <div class="question-content">
        <div class="question-text" id="questionText"></div>
        <div class="options-grid" id="optionsContainer"></div>
      </div>
      
      <div class="controls">
        <div class="nav-buttons">
          <button type="button" id="prevBtn" class="secondary">‚Üê Previous</button>
          <button type="button" id="nextBtn">Next ‚Üí</button>
        </div>
        <button type="button" id="submitBtn" class="hidden">üéØ Submit Quiz</button>
      </div>
    </div>

    <!-- Results Area -->
    <div id="resultsArea" class="results hidden">
      <h1>üéâ Quiz Completed!</h1>
      <div id="scoreDisplay" class="score-display"></div>
      <div id="summaryContainer" class="summary"></div>
    </div>

    <!-- Footer -->
    <footer>
      <p><strong>Yeriel Bracha Coding Club</strong><br>¬© 2025 - Excellence in Computing Education</p>
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCY9oturc9bql33PSUkfNUptcHXla2RWN4",
      authDomain: "tracha-xx.firebaseapp.com",
      databaseURL: "https://tracha-xx-default-rtdb.firebaseio.com",
      projectId: "tracha-xx",
      storageBucket: "tracha-xx.appspot.com",
      messagingSenderId: "914440906583",
      appId: "1:914440906583:web:123abc456xyz"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Quiz Configuration
    const QUIZ_DURATION = 30 * 60; // 30 minutes in seconds
    const TOTAL_QUESTIONS = 30; // Show 30 out of 40 questions
    const COOLDOWN_HOURS = 12;

    // Quiz Data - All 40 questions
    const quizData = [
      {
        q: "1. Which device is used to move items on the computer screen?",
        options: ["Keyboard", "Mouse", "Monitor", "Printer"],
        answer: "Mouse"
      },
      {
        q: "2. When you right-click on the desktop, what usually appears?",
        options: ["Recycle Bin", "Shortcut menu", "Toolbar", "File explorer"],
        answer: "Shortcut menu"
      },
      {
        q: "3. A folder is used to ________ files on the computer.",
        options: ["Print", "Store and organize", "Delete", "Display"],
        answer: "Store and organize"
      },
      {
        q: "4. What is data?",
        options: [
          "Information collected for a purpose",
          "A computer program",
          "A keyboard key",
          "A software error"
        ],
        answer: "Information collected for a purpose"
      },
      {
        q: "5. Which of these is an example of an input device?",
        options: ["Printer", "Speaker", "Keyboard", "Monitor"],
        answer: "Keyboard"
      },
      {
        q: "6. The result produced after data has been processed is called ________.",
        options: ["Input", "Output", "Storage", "Hardware"],
        answer: "Output"
      },
      {
        q: "7. The desktop background can be changed by choosing ________.",
        options: ["Personalize", "Copy", "Paste", "Edit"],
        answer: "Personalize"
      },
      {
        q: "8. Which of the following is a good reason for using folders?",
        options: [
          "To make the desktop look beautiful",
          "To organize and find files easily",
          "To delete all old files",
          "To hide programs"
        ],
        answer: "To organize and find files easily"
      },
      {
        q: "9. The fifth generation of computers is mainly known for ________.",
        options: [
          "Artificial intelligence",
          "Vacuum tubes",
          "Punch cards",
          "Magnetic drums"
        ],
        answer: "Artificial intelligence"
      },
      {
        q: "10. Which storage device uses laser light to store data?",
        options: ["Flash drive", "Optical disc", "Floppy disk", "Hard disk"],
        answer: "Optical disc"
      },
      {
        q: "11. Which device helps a teacher record her lesson as voice data?",
        options: ["Microphone", "Printer", "Monitor", "Speaker"],
        answer: "Microphone"
      },
      {
        q: "12. The data 12, 15, 18, 10, 20 ‚Äî what is the maximum value?",
        options: ["10", "12", "20", "15"],
        answer: "20"
      },
      {
        q: "13. To calculate the average of numbers, you ________.",
        options: [
          "Add them and divide by how many they are",
          "Subtract and multiply",
          "Add and subtract",
          "Only add the biggest one"
        ],
        answer: "Add them and divide by how many they are"
      },
      {
        q: "14. Which part of the computer shows pictures and videos?",
        options: ["CPU", "Monitor", "Mouse", "Keyboard"],
        answer: "Monitor"
      },
      {
        q: "15. A device used to print documents on paper is called ________.",
        options: ["Scanner", "Speaker", "Printer", "Mouse"],
        answer: "Printer"
      },
      {
        q: "16. What does the term 'generation' of computers refer to?",
        options: [
          "The age or technology level of computers",
          "The brand of the computer",
          "The color of computers",
          "The size of the computer screen"
        ],
        answer: "The age or technology level of computers"
      },
      {
        q: "17. To open a program quickly using the mouse, you ________.",
        options: ["Double-click", "Right-click", "Scroll", "Drag"],
        answer: "Double-click"
      },
      {
        q: "18. Which of these actions will delete a file completely?",
        options: ["Right-click ‚Üí Delete", "Copy ‚Üí Paste", "Rename ‚Üí Save", "Open ‚Üí Print"],
        answer: "Right-click ‚Üí Delete"
      },
      {
        q: "19. The brain of the computer that processes data is the ________.",
        options: ["Monitor", "CPU", "Keyboard", "Speaker"],
        answer: "CPU"
      },
      {
        q: "20. A computer that is very large and used in banks is a ________.",
        options: ["Laptop", "Desktop", "Mainframe", "Tablet"],
        answer: "Mainframe"
      },
      {
        q: "21. The mean of 5, 10, 15, 20, 25 is ________.",
        options: ["10", "15", "20", "25"],
        answer: "15"
      },
      {
        q: "22. Which tool can record a teacher's voice lesson for later use?",
        options: ["Camera", "Phone recorder", "Printer", "Monitor"],
        answer: "Phone recorder"
      },
      {
        q: "23. Which operation will you perform to find the total of numbers?",
        options: ["Addition", "Division", "Subtraction", "Comparison"],
        answer: "Addition"
      },
      {
        q: "24. The best way to keep the mouse clean is to ________.",
        options: ["Cover it and clean it gently", "Put it in water", "Drop it", "Paint it"],
        answer: "Cover it and clean it gently"
      },
      {
        q: "25. The process of changing raw data into useful information is called ________.",
        options: ["Processing", "Typing", "Recording", "Saving"],
        answer: "Processing"
      },
      {
        q: "26. When you move the mouse, the ________ moves on the screen.",
        options: ["Icon", "Cursor", "Keyboard", "Monitor"],
        answer: "Cursor"
      },
      {
        q: "27. Which generation of computers introduced the microprocessor?",
        options: ["Second", "Third", "Fourth", "Fifth"],
        answer: "Fourth"
      },
      {
        q: "28. A file containing songs is best stored in which folder?",
        options: ["My Music", "My Pictures", "My Documents", "Recycle Bin"],
        answer: "My Music"
      },
      {
        q: "29. To see files that were deleted, open the ________.",
        options: ["Recycle Bin", "Documents folder", "Control Panel", "Settings"],
        answer: "Recycle Bin"
      },
      {
        q: "30. Data collected from a class test is an example of ________.",
        options: ["Academic data", "Image data", "Sound data", "Random data"],
        answer: "Academic data"
      },
      {
        q: "31. Which of the following is NOT an output device?",
        options: ["Monitor", "Printer", "Speaker", "Keyboard"],
        answer: "Keyboard"
      },
      {
        q: "32. RAM stands for ________.",
        options: ["Random Access Memory", "Read Access Memory", "Rapid Access Memory", "Real Access Memory"],
        answer: "Random Access Memory"
      },
      {
        q: "33. The first generation of computers used ________.",
        options: ["Transistors", "Vacuum tubes", "Integrated circuits", "Microprocessors"],
        answer: "Vacuum tubes"
      },
      {
        q: "34. Which key combination is used to copy text?",
        options: ["Ctrl + C", "Ctrl + V", "Ctrl + X", "Ctrl + Z"],
        answer: "Ctrl + C"
      },
      {
        q: "35. A byte consists of ________ bits.",
        options: ["4", "8", "16", "32"],
        answer: "8"
      },
      {
        q: "36. Which of these is a web browser?",
        options: ["Microsoft Word", "Google Chrome", "Adobe Photoshop", "Windows Media Player"],
        answer: "Google Chrome"
      },
      {
        q: "37. The extension .txt indicates a ________ file.",
        options: ["Image", "Video", "Text", "Audio"],
        answer: "Text"
      },
      {
        q: "38. Which component stores data permanently?",
        options: ["RAM", "CPU", "Hard disk", "Cache"],
        answer: "Hard disk"
      },
      {
        q: "39. What does WWW stand for?",
        options: ["World Wide Web", "World Web Wide", "Wide World Web", "Web World Wide"],
        answer: "World Wide Web"
      },
      {
        q: "40. Which of these is an example of system software?",
        options: ["Microsoft Word", "Windows 10", "Google Chrome", "Adobe Photoshop"],
        answer: "Windows 10"
      }
    ];

    // Global Variables
    let studentName = "";
    let currentQuestion = 0;
    let selectedQuestions = [];
    let userAnswers = [];
    let quizTimer;
    let timeRemaining = QUIZ_DURATION;
    let quizStarted = false;

    // DOM Elements
    const namePage = document.getElementById("namePage");
    const welcomePage = document.getElementById("welcomePage");
    const countdownScreen = document.getElementById("countdownScreen");
    const quizArea = document.getElementById("quizArea");
    const resultsArea = document.getElementById("resultsArea");
    const lockMessage = document.getElementById("lockMessage");

    // Quiz Elements
    const questionCounter = document.getElementById("questionCounter");
    const timer = document.getElementById("timer");
    const questionText = document.getElementById("questionText");
    const optionsContainer = document.getElementById("optionsContainer");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");

    // Results Elements
    const scoreDisplay = document.getElementById("scoreDisplay");
    const summaryContainer = document.getElementById("summaryContainer");

    // Utility Functions
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // Check Student Eligibility
    async function checkStudentEligibility(name) {
      try {
        const studentRef = ref(db, `quizResults`);
        const snapshot = await get(studentRef);
        
        if (!snapshot.exists()) {
          return { canTake: true };
        }

        const allScores = snapshot.val();
        const studentScores = Object.values(allScores).filter(score => 
          score.name && score.name.toLowerCase() === name.toLowerCase()
        );

        if (studentScores.length === 0) {
          return { canTake: true };
        }

        // Find most recent submission
        const lastSubmission = studentScores.sort((a, b) => 
          new Date(b.date) - new Date(a.date)
        )[0];

        const lastSubmissionTime = new Date(lastSubmission.date);
        const now = new Date();
        const timeDiff = now - lastSubmissionTime;
        const hoursDiff = timeDiff / (1000 * 60 * 60);

        if (hoursDiff < COOLDOWN_HOURS) {
          const remainingTime = (COOLDOWN_HOURS * 60 * 60 * 1000) - timeDiff;
          return { 
            canTake: false, 
            remainingTime: remainingTime,
            lastScore: lastSubmission.total || 0,
            lastPercentage: Math.round((lastSubmission.total || 0) / TOTAL_QUESTIONS * 100)
          };
        }

        return { canTake: true };
      } catch (error) {
        console.error("Error checking eligibility:", error);
        return { canTake: true };
      }
    }

    // Event Listeners
    document.getElementById("proceedBtn").addEventListener("click", async () => {
      const nameInput = document.getElementById("studentName").value.trim();
      if (!nameInput) {
        alert("Please enter your name before proceeding!");
        return;
      }
      
      studentName = nameInput;
      const eligibility = await checkStudentEligibility(studentName);
      
      if (!eligibility.canTake) {
        const hours = Math.floor(eligibility.remainingTime / (1000 * 60 * 60));
        const minutes = Math.floor((eligibility.remainingTime % (1000 * 60 * 60)) / (1000 * 60));
        
        lockMessage.classList.remove("hidden");
        lockMessage.innerHTML = `
          <p>‚è∞ You have already completed this quiz recently.</p>
          <p>Last Score: ${eligibility.lastScore}/${TOTAL_QUESTIONS} (${eligibility.lastPercentage}%)</p>
          <p>You can try again in: ${hours}h ${minutes}m</p>
        `;
        return;
      }

      namePage.classList.add("hidden");
      welcomePage.classList.remove("hidden");
    });

    document.getElementById("startBtn").addEventListener("click", () => {
      welcomePage.classList.add("hidden");
      startCountdown();
    });

    // Countdown Function
    function startCountdown() {
      countdownScreen.classList.remove("hidden");
      let counter = 3;
      countdownScreen.textContent = `Get Ready... ${counter}`;

      const countdown = setInterval(() => {
        counter--;
        if (counter > 0) {
          countdownScreen.textContent = `${counter}...`;
        } else {
          clearInterval(countdown);
          countdownScreen.textContent = "Begin!";
          setTimeout(() => {
            countdownScreen.classList.add("hidden");
            initializeQuiz();
          }, 800);
        }
      }, 1000);
    }

    // Initialize Quiz
    function initializeQuiz() {
      // Select 30 random questions from the 40 available
      const shuffledQuestions = shuffleArray(quizData);
      selectedQuestions = shuffledQuestions.slice(0, TOTAL_QUESTIONS);
      userAnswers = new Array(TOTAL_QUESTIONS).fill(null);
      currentQuestion = 0;
      quizStarted = true;
      
      quizArea.classList.remove("hidden");
      loadQuestion();
      startTimer();
      
      // Prevent page refresh
      window.addEventListener('beforeunload', function (e) {
        if (quizStarted) {
          e.preventDefault();
          e.returnValue = '';
        }
      });
    }

    // Load Question
    function loadQuestion() {
      const question = selectedQuestions[currentQuestion];
      
      // Update counter
      questionCounter.textContent = `Question ${currentQuestion + 1} of ${TOTAL_QUESTIONS}`;
      
      // Update question text
      questionText.textContent = question.q;
      
      // Clear and populate options
      optionsContainer.innerHTML = "";
      question.options.forEach((option, index) => {
        const button = document.createElement("button");
        button.className = "option-button secondary";
        button.textContent = option;
        
        if (userAnswers[currentQuestion] === option) {
          button.classList.add("selected");
        }
        
        button.addEventListener("click", () => selectAnswer(option));
        optionsContainer.appendChild(button);
      });
      
      // Update navigation buttons
      prevBtn.disabled = currentQuestion === 0;
      
      if (currentQuestion === TOTAL_QUESTIONS - 1) {
        nextBtn.classList.add("hidden");
        submitBtn.classList.remove("hidden");
      } else {
        nextBtn.classList.remove("hidden");
        submitBtn.classList.add("hidden");
      }
    }

    // Select Answer
    function selectAnswer(answer) {
      userAnswers[currentQuestion] = answer;
      loadQuestion(); // Refresh to show selection
    }

    // Navigation
    prevBtn.addEventListener("click", () => {
      if (currentQuestion > 0) {
        currentQuestion--;
        loadQuestion();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentQuestion < TOTAL_QUESTIONS - 1) {
        currentQuestion++;
        loadQuestion();
      }
    });

    submitBtn.addEventListener("click", () => {
      if (confirm("Are you sure you want to submit your quiz? You cannot change answers after submission.")) {
        finishQuiz();
      }
    });

    // Timer Functions
    function startTimer() {
      updateTimerDisplay();
      quizTimer = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        
        if (timeRemaining <= 0) {
          clearInterval(quizTimer);
          autoSubmitQuiz();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      timer.textContent = formatTime(timeRemaining);
      
      // Add warning class for last 5 minutes
      if (timeRemaining <= 300) {
        timer.classList.add("warning");
      }
    }

    function stopTimer() {
      if (quizTimer) {
        clearInterval(quizTimer);
      }
    }

    // Auto Submit
    function autoSubmitQuiz() {
      alert("Time's up! Your quiz will be submitted automatically.");
      finishQuiz(true);
    }

    // Finish Quiz
    async function finishQuiz(isAutoSubmit = false) {
      quizStarted = false;
      stopTimer();
      
      quizArea.classList.add("hidden");
      resultsArea.classList.remove("hidden");
      
      // Calculate score
      let correctAnswers = 0;
      const reviewHTML = [];
      
      selectedQuestions.forEach((question, index) => {
        const userAnswer = userAnswers[index] || "(No answer)";
        const isCorrect = userAnswer === question.answer;
        
        if (isCorrect) correctAnswers++;
        
        reviewHTML.push(`
          <div class="question-review ${isCorrect ? 'correct' : 'wrong'}">
            <p><strong>Q${index + 1}:</strong> ${question.q}</p>
            <p>Your answer: <span class="${isCorrect ? 'correct' : 'wrong'}">${userAnswer}</span></p>
            <p>Correct answer: <span class="correct">${question.answer}</span></p>
          </div>
        `);
      });
      
      const percentage = Math.round((correctAnswers / TOTAL_QUESTIONS) * 100);
      const timeUsed = QUIZ_DURATION - timeRemaining;
      
      // Display results
      scoreDisplay.innerHTML = `
        <h2>üìä Your Results</h2>
        <p><strong>Student:</strong> ${studentName}</p>
        <p><strong>Score:</strong> ${correctAnswers} / ${TOTAL_QUESTIONS} (${percentage}%)</p>
        <p><strong>Time Used:</strong> ${formatTime(timeUsed)}</p>
        ${isAutoSubmit ? '<p><strong>Status:</strong> Auto-submitted (Time expired)</p>' : ''}
        <p><strong>Grade:</strong> ${percentage >= 70 ? 'üéâ Excellent!' : percentage >= 50 ? 'üëç Good!' : 'üìö Keep studying!'}</p>
      `;
      
      summaryContainer.innerHTML = `
        <h3>üìã Detailed Review</h3>
        ${reviewHTML.join('')}
      `;
      
      // Save to Firebase
      try {
        const newRef = push(ref(db, "quizResults"));
        
        await set(newRef, {
          name: studentName,
          sectionA: correctAnswers,
          sectionB: 0,
          total: correctAnswers,
          percentage: percentage,
          timeUsed: timeUsed,
          autoSubmitted: isAutoSubmit,
          date: new Date().toLocaleString(),
          timestamp: new Date().toISOString(),
          subject: "Introduction to Computing"
        });
        
        // Show success message
        const successDiv = document.createElement('div');
        successDiv.style.cssText = `
          background: rgba(40, 167, 69, 0.9);
          color: white;
          padding: 15px;
          border-radius: 10px;
          margin-top: 20px;
          text-align: center;
          font-weight: 600;
        `;
        successDiv.innerHTML = `‚úÖ Score saved successfully!<br>‚è∞ You can retake this quiz after ${COOLDOWN_HOURS} hours.`;
        resultsArea.appendChild(successDiv);
        
      } catch (error) {
        console.error("Error saving results:", error);
        
        // Show error message
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
          background: rgba(220, 53, 69, 0.9);
          color: white;
          padding: 15px;
          border-radius: 10px;
          margin-top: 20px;
          text-align: center;
          font-weight: 600;
        `;
        errorDiv.innerHTML = '‚ö†Ô∏è Quiz completed but could not save to database. Please contact your instructor.';
        resultsArea.appendChild(errorDiv);
      }
    }
  </script>
</body>
</html>
