<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Quiz Results Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    header {
      background: rgba(255, 255, 255, 0.95);
      color: #2c3e50;
      padding: 25px;
      text-align: center;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    header h1 {
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    header p {
      font-size: 1.1em;
      color: #7f8c8d;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 35px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    .loading {
      text-align: center;
      padding: 60px;
      color: #7f8c8d;
      font-size: 1.2em;
    }
    
    .loading::before {
      content: "üîÑ";
      font-size: 2em;
      display: block;
      margin-bottom: 15px;
      animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: center;
      font-size: 1.1em;
    }
    
    .info {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: center;
      font-size: 1.1em;
    }
    
    .stats-section {
      margin-bottom: 40px;
    }
    
    .section-title {
      font-size: 1.8em;
      color: #2c3e50;
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 3px solid #3498db;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 25px;
      margin-bottom: 35px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card h3 {
      font-size: 2.5em;
      margin-bottom: 8px;
      font-weight: 700;
    }
    
    .stat-card p {
      font-size: 1em;
      opacity: 0.9;
      font-weight: 500;
    }
    
    .filters-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      border: 2px solid #e9ecef;
    }
    
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      align-items: end;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    
    .filter-group label {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .filter-group input, .filter-group select {
      padding: 12px 15px;
      border: 2px solid #bdc3c7;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }
    
    .filter-group input:focus, .filter-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #2980b9, #3498db);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(46, 204, 113, 0.3);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      color: white;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #7f8c8d, #95a5a6);
      transform: translateY(-2px);
    }
    
    .results-table-container {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-top: 25px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: linear-gradient(135deg, #34495e, #2c3e50);
      color: white;
      padding: 18px 15px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 1px;
    }
    
    td {
      padding: 15px;
      border-bottom: 1px solid #ecf0f1;
      vertical-align: middle;
    }
    
    tr:hover {
      background: rgba(52, 152, 219, 0.05);
    }
    
    .score-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9em;
      text-align: center;
      min-width: 60px;
    }
    
    .score-excellent { 
      background: linear-gradient(135deg, #d5f4e6, #a8e6cf); 
      color: #27ae60; 
      border: 2px solid #27ae60;
    }
    
    .score-good { 
      background: linear-gradient(135deg, #fef9e7, #f7dc6f); 
      color: #f39c12; 
      border: 2px solid #f39c12;
    }
    
    .score-needs-improvement { 
      background: linear-gradient(135deg, #fadbd8, #f1948a); 
      color: #e74c3c; 
      border: 2px solid #e74c3c;
    }
    
    .student-name {
      font-weight: 600;
      color: #2c3e50;
      font-size: 1.05em;
    }
    
    .attempt-info {
      font-size: 0.85em;
      color: #7f8c8d;
      margin-top: 3px;
    }
    
    .date-time {
      font-size: 0.9em;
      color: #7f8c8d;
    }
    
    .no-results {
      text-align: center;
      padding: 60px;
      color: #7f8c8d;
      font-size: 1.2em;
    }
    
    .no-results::before {
      content: "üìù";
      font-size: 3em;
      display: block;
      margin-bottom: 15px;
    }
    
    .hidden { display: none; }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 25px;
      flex-wrap: wrap;
    }
    
    .summary-card {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border-left: 5px solid #3498db;
    }
    
    .summary-card h4 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 1.2em;
    }
    
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .summary-stat {
      text-align: center;
      padding: 10px;
      background: white;
      border-radius: 8px;
    }
    
    .summary-stat strong {
      display: block;
      font-size: 1.5em;
      color: #3498db;
      margin-bottom: 5px;
    }
    
    .summary-stat span {
      font-size: 0.9em;
      color: #7f8c8d;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .filters-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
      
      table {
        font-size: 0.9em;
      }
      
      th, td {
        padding: 12px 8px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>üìä Quiz Results Dashboard</h1>
    <p>Comprehensive student performance tracking and analytics</p>
  </header>

  <div class="container">
    <div id="loadingArea" class="loading">
      Loading quiz results and preparing dashboard...
    </div>

    <div id="errorArea" class="error hidden">
      ‚ùå Unable to connect to Firebase. Please check your configuration.
    </div>

    <div id="infoArea" class="info hidden">
      üì± Using local storage data. Results are saved locally in your browser.
    </div>

    <div id="mainContent" class="hidden">
      <!-- Statistics Overview -->
      <div class="stats-section">
        <h2 class="section-title">üìà Overview Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <h3 id="totalStudents">0</h3>
            <p>Unique Students</p>
          </div>
          <div class="stat-card">
            <h3 id="totalAttempts">0</h3>
            <p>Total Attempts</p>
          </div>
          <div class="stat-card">
            <h3 id="averageScore">0%</h3>
            <p>Average Score</p>
          </div>
          <div class="stat-card">
            <h3 id="highestScore">0%</h3>
            <p>Highest Score</p>
          </div>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="filters-section">
        <h3 class="section-title">üîç Filter Results</h3>
        <div class="filters-grid">
          <div class="filter-group">
            <label for="dateFrom">From Date:</label>
            <input type="date" id="dateFrom">
          </div>
          <div class="filter-group">
            <label for="dateTo">To Date:</label>
            <input type="date" id="dateTo">
          </div>
          <div class="filter-group">
            <label for="studentSearch">Student Name:</label>
            <input type="text" id="studentSearch" placeholder="Search by name...">
          </div>
          <div class="filter-group">
            <label for="scoreFilter">Score Range:</label>
            <select id="scoreFilter">
              <option value="all">All Scores</option>
              <option value="excellent">Excellent (80-100%)</option>
              <option value="good">Good (60-79%)</option>
              <option value="needs-improvement">Needs Improvement (0-59%)</option>
            </select>
          </div>
          <div class="filter-group">
            <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
          </div>
          <div class="filter-group">
            <button class="btn btn-secondary" id="clearFilters">Clear All</button>
          </div>
        </div>
      </div>

      <!-- Summary for Filtered Results -->
      <div id="filteredSummary" class="summary-card hidden">
        <h4>üìã Filtered Results Summary</h4>
        <div class="summary-stats">
          <div class="summary-stat">
            <strong id="filteredCount">0</strong>
            <span>Results Found</span>
          </div>
          <div class="summary-stat">
            <strong id="filteredAverage">0%</strong>
            <span>Average Score</span>
          </div>
          <div class="summary-stat">
            <strong id="filteredStudents">0</strong>
            <span>Students</span>
          </div>
          <div class="summary-stat">
            <strong id="filteredDateRange">-</strong>
            <span>Date Range</span>
          </div>
        </div>
      </div>

      <!-- Results Table -->
      <div class="results-table-container">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>Student Name</th>
              <th>Score</th>
              <th>Percentage</th>
              <th>Time Used</th>
              <th>Date & Time</th>
              <th>Subject</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="resultsTableBody">
          </tbody>
        </table>
        
        <div id="noResults" class="no-results hidden">
          No quiz results found for the selected criteria.
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="btn btn-success" id="exportCSV">üì• Export to CSV</button>
        <button class="btn btn-success" id="exportFiltered">üì• Export Filtered Results</button>
        <button class="btn btn-primary" id="refreshData">üîÑ Refresh Data</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Firebase configuration - Using the same config as the quiz
    const firebaseConfig = {
      apiKey: "AIzaSyCY9oturc9bql33PSUkfNUptcHXla2RWN4",
      authDomain: "tracha-xx.firebaseapp.com",
      databaseURL: "https://tracha-xx-default-rtdb.firebaseio.com",
      projectId: "tracha-xx",
      storageBucket: "tracha-xx.appspot.com",
      messagingSenderId: "914440906583",
      appId: "1:914440906583:web:123abc456xyz"
    };

    let app, db;
    let useLocalStorage = false;

    // Global variables
    let allResults = [];
    let filteredResults = [];
    let studentAttempts = {};

    // DOM elements
    const loadingArea = document.getElementById("loadingArea");
    const errorArea = document.getElementById("errorArea");
    const infoArea = document.getElementById("infoArea");
    const mainContent = document.getElementById("mainContent");
    const resultsTableBody = document.getElementById("resultsTableBody");
    const noResults = document.getElementById("noResults");
    const filteredSummary = document.getElementById("filteredSummary");

    // Filter elements
    const dateFrom = document.getElementById("dateFrom");
    const dateTo = document.getElementById("dateTo");
    const studentSearch = document.getElementById("studentSearch");
    const scoreFilter = document.getElementById("scoreFilter");
    const applyFiltersBtn = document.getElementById("applyFilters");
    const clearFiltersBtn = document.getElementById("clearFilters");

    // Action buttons
    const exportCSVBtn = document.getElementById("exportCSV");
    const exportFilteredBtn = document.getElementById("exportFiltered");
    const refreshDataBtn = document.getElementById("refreshData");

    // Try to initialize Firebase, fallback to localStorage if it fails
    try {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      console.log("Firebase initialized successfully");
      fetchQuizResults();
    } catch (error) {
      console.warn("Firebase initialization failed, using localStorage:", error);
      useLocalStorage = true;
      loadLocalStorageResults();
    }

    // Initialize the dashboard
    function initializeDashboard() {
      // Set default date range (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
      
      dateTo.value = today.toISOString().split('T')[0];
      dateFrom.value = thirtyDaysAgo.toISOString().split('T')[0];
    }

    // Load results from localStorage
    function loadLocalStorageResults() {
      loadingArea.classList.add("hidden");
      
      const localData = localStorage.getItem('quizResults');
      if (!localData) {
        showInfo("üìù No quiz results found in local storage. Students need to take the quiz first.");
        return;
      }

      try {
        const data = JSON.parse(localData);
        if (data.length === 0) {
          showInfo("üìù No quiz results found. Students need to take the quiz first.");
          return;
        }

        // Convert localStorage format to Firebase format
        const firebaseFormat = {};
        data.forEach((item, index) => {
          firebaseFormat[item.id || index] = {
            name: item.name,
            total: item.total,
            percentage: item.percentage,
            date: item.date || item.timestamp,
            subject: item.subject || "Introduction to Computing",
            timeUsed: item.timeUsed || 0,
            autoSubmitted: item.autoSubmitted || false
          };
        });

        processResults(firebaseFormat);
        showMainContent();
        showInfo("üì± Using local storage data. Results are saved locally in your browser.");
        applyFilters();
      } catch (error) {
        console.error("Error processing localStorage results:", error);
        showError("‚ùå Error processing local quiz data. Check console for details.");
      }
    }

    // Fetch quiz results from Firebase
    function fetchQuizResults() {
      const quizRef = ref(db, "quizResults");
      
      onValue(quizRef, (snapshot) => {
        loadingArea.classList.add("hidden");
        
        const data = snapshot.val();
        if (!data) {
          showError("üìù No quiz results found in Firebase. Students need to take the quiz first.");
          return;
        }

        try {
          processResults(data);
          showMainContent();
          applyFilters();
        } catch (error) {
          console.error("Error processing results:", error);
          showError("‚ùå Error processing quiz data. Check console for details.");
        }
      }, (error) => {
        loadingArea.classList.add("hidden");
        console.error("Firebase error:", error);
        // Fallback to localStorage
        useLocalStorage = true;
        loadLocalStorageResults();
      });
    }

    // Process raw data
    function processResults(data) {
      allResults = [];
      studentAttempts = {};

      Object.entries(data).forEach(([key, entry]) => {
        if (!entry.name || !entry.date) return;

        // Parse the date properly - handle different date formats
        let resultDate;
        if (entry.date) {
          resultDate = new Date(entry.date);
          if (isNaN(resultDate.getTime())) {
            // Try parsing as timestamp
            resultDate = new Date(parseInt(entry.date));
            if (isNaN(resultDate.getTime())) {
              console.warn("Invalid date format:", entry.date);
              return;
            }
          }
        } else {
          resultDate = new Date();
        }

        const studentName = entry.name.trim();
        const result = {
          id: key,
          name: studentName,
          total: entry.total || 0,
          percentage: entry.percentage || Math.round(((entry.total || 0) / (entry.maxScore || 20)) * 100),
          date: resultDate,
          dateString: resultDate.toLocaleDateString(),
          subject: entry.subject || "Introduction to Computing",
          timeUsed: entry.timeUsed || 0,
          autoSubmitted: entry.autoSubmitted || false
        };

        allResults.push(result);

        // Track student attempts
        if (!studentAttempts[studentName]) {
          studentAttempts[studentName] = [];
        }
        studentAttempts[studentName].push(result);
      });

      // Sort attempts for each student by date
      Object.keys(studentAttempts).forEach(student => {
        studentAttempts[student].sort((a, b) => a.date - b.date);
        studentAttempts[student].forEach((attempt, index) => {
          attempt.attemptNumber = index + 1;
        });
      });

      // Sort all results by date (newest first)
      allResults.sort((a, b) => b.date - a.date);

      updateOverallStats();
      initializeDashboard();
    }

    // Update overall statistics
    function updateOverallStats() {
      const uniqueStudents = Object.keys(studentAttempts).length;
      const totalAttempts = allResults.length;
      const averageScore = totalAttempts > 0 ? 
        Math.round(allResults.reduce((sum, r) => sum + r.percentage, 0) / totalAttempts) : 0;
      const highestScore = totalAttempts > 0 ? 
        Math.max(...allResults.map(r => r.percentage)) : 0;

      document.getElementById("totalStudents").textContent = uniqueStudents;
      document.getElementById("totalAttempts").textContent = totalAttempts;
      document.getElementById("averageScore").textContent = averageScore + "%";
      document.getElementById("highestScore").textContent = highestScore + "%";
    }

    // Apply filters to results
    function applyFilters() {
      const fromDate = dateFrom.value ? new Date(dateFrom.value) : null;
      const toDate = dateTo.value ? new Date(dateTo.value + "T23:59:59") : null;
      const searchTerm = studentSearch.value.toLowerCase().trim();
      const scoreRange = scoreFilter.value;

      filteredResults = allResults.filter(result => {
        // Date filter
        if (fromDate && result.date < fromDate) return false;
        if (toDate && result.date > toDate) return false;

        // Name filter
        if (searchTerm && !result.name.toLowerCase().includes(searchTerm)) return false;

        // Score filter
        if (scoreRange !== 'all') {
          const percentage = result.percentage;
          switch (scoreRange) {
            case 'excellent':
              if (percentage < 80) return false;
              break;
            case 'good':
              if (percentage < 60 || percentage >= 80) return false;
              break;
            case 'needs-improvement':
              if (percentage >= 60) return false;
              break;
          }
        }

        return true;
      });

      updateFilteredSummary();
      displayResults();
    }

    // Update filtered results summary
    function updateFilteredSummary() {
      if (filteredResults.length === 0) {
        filteredSummary.classList.add("hidden");
        return;
      }

      filteredSummary.classList.remove("hidden");
      
      const uniqueFilteredStudents = new Set(filteredResults.map(r => r.name)).size;
      const filteredAverage = Math.round(
        filteredResults.reduce((sum, r) => sum + r.percentage, 0) / filteredResults.length
      );
      
      const dates = filteredResults.map(r => r.date);
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));
      const dateRange = minDate.toLocaleDateString() + " - " + maxDate.toLocaleDateString();

      document.getElementById("filteredCount").textContent = filteredResults.length;
      document.getElementById("filteredAverage").textContent = filteredAverage + "%";
      document.getElementById("filteredStudents").textContent = uniqueFilteredStudents;
      document.getElementById("filteredDateRange").textContent = dateRange;
    }

    // Display results in table
    function displayResults() {
      resultsTableBody.innerHTML = "";

      if (filteredResults.length === 0) {
        noResults.classList.remove("hidden");
        document.getElementById("resultsTable").classList.add("hidden");
        return;
      }

      noResults.classList.add("hidden");
      document.getElementById("resultsTable").classList.remove("hidden");

      filteredResults.forEach(result => {
        const row = document.createElement("tr");
        
        let scoreClass = "score-needs-improvement";
        if (result.percentage >= 80) scoreClass = "score-excellent";
        else if (result.percentage >= 60) scoreClass = "score-good";

        const totalAttempts = studentAttempts[result.name]?.length || 1;
        const timeUsedFormatted = formatTime(result.timeUsed);

        row.innerHTML = `
          <td>
            <div class="student-name">${result.name}</div>
            <div class="attempt-info">Attempt #${result.attemptNumber} of ${totalAttempts}</div>
          </td>
          <td><strong>${result.total}/${result.maxScore || 20}</strong></td>
          <td><span class="score-badge ${scoreClass}">${result.percentage}%</span></td>
          <td>${timeUsedFormatted}</td>
          <td>
            <div>${result.date.toLocaleDateString()}</div>
            <div class="date-time">${result.date.toLocaleTimeString()}</div>
          </td>
          <td>${result.subject}</td>
          <td>${result.autoSubmitted ? '‚è∞ Auto-submitted' : '‚úÖ Completed'}</td>
        `;

        resultsTableBody.appendChild(row);
      });
    }

    // Format time helper
    function formatTime(seconds) {
      if (!seconds) return "N/A";
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    // Export to CSV
    function exportToCSV(results, filename) {
      const headers = ["Student Name", "Score", "Percentage", "Time Used", "Date", "Time", "Subject", "Status", "Attempt Number"];
      const csvContent = [
        headers.join(","),
        ...results.map(r => [
          `"${r.name}"`,
          `${r.total}/${r.maxScore || 20}`,
          `${r.percentage}%`,
          formatTime(r.timeUsed),
          r.date.toLocaleDateString(),
          r.date.toLocaleTimeString(),
          `"${r.subject}"`,
          r.autoSubmitted ? "Auto-submitted" : "Completed",
          r.attemptNumber
        ].join(","))
      ].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", filename);
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Show error message
    function showError(message) {
      errorArea.innerHTML = message;
      errorArea.classList.remove("hidden");
      infoArea.classList.add("hidden");
      mainContent.classList.add("hidden");
    }

    // Show info message
    function showInfo(message) {
      infoArea.innerHTML = message;
      infoArea.classList.remove("hidden");
      errorArea.classList.add("hidden");
      mainContent.classList.remove("hidden");
    }

    // Show main content
    function showMainContent() {
      errorArea.classList.add("hidden");
      infoArea.classList.add("hidden");
      mainContent.classList.remove("hidden");
    }

    // Event listeners
    applyFiltersBtn.addEventListener("click", applyFilters);
    
    clearFiltersBtn.addEventListener("click", () => {
      dateFrom.value = "";
      dateTo.value = "";
      studentSearch.value = "";
      scoreFilter.value = "all";
      applyFilters();
    });

    exportCSVBtn.addEventListener("click", () => {
      exportToCSV(allResults, `all_quiz_results_${new Date().toISOString().split('T')[0]}.csv`);
    });

    exportFilteredBtn.addEventListener("click", () => {
      exportToCSV(filteredResults, `filtered_quiz_results_${new Date().toISOString().split('T')[0]}.csv`);
    });

    refreshDataBtn.addEventListener("click", () => {
      loadingArea.classList.remove("hidden");
      mainContent.classList.add("hidden");
      if (useLocalStorage) {
        loadLocalStorageResults();
      } else {
        fetchQuizResults();
      }
    });

    // Real-time search
    studentSearch.addEventListener("input", applyFilters);
  </script>
</body>
</html>



