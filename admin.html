<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Quiz Results Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    header {
      background: rgba(255, 255, 255, 0.95);
      color: #2c3e50;
      padding: 25px;
      text-align: center;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    header h1 {
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    header p {
      font-size: 1.1em;
      color: #7f8c8d;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 35px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    h2 {
      color: #2c3e50;
      margin-bottom: 25px;
      font-size: 1.8em;
      border-bottom: 3px solid #3498db;
      padding-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 25px;
      margin-bottom: 35px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card h3 {
      font-size: 2.5em;
      margin-bottom: 8px;
      font-weight: 700;
    }
    
    .stat-card p {
      font-size: 1em;
      opacity: 0.9;
    }
    
    .loading {
      text-align: center;
      padding: 60px;
      color: #7f8c8d;
      font-size: 1.3em;
    }
    
    .loading::before {
      content: "üîÑ";
      font-size: 2em;
      display: block;
      margin-bottom: 15px;
      animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin: 25px 0;
      text-align: center;
      font-size: 1.1em;
    }
    
    .date-filter {
      background: rgba(52, 152, 219, 0.1);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      border: 2px solid rgba(52, 152, 219, 0.2);
    }
    
    .date-filter h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 1.3em;
    }
    
    .date-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .date-input {
      padding: 12px 15px;
      border: 2px solid #bdc3c7;
      border-radius: 8px;
      font-size: 1em;
      background: white;
      transition: border-color 0.3s ease;
    }
    
    .date-input:focus {
      outline: none;
      border-color: #3498db;
    }
    
    .filter-btn {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .filter-btn:hover {
      background: linear-gradient(135deg, #2980b9, #3498db);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
    }
    
    .clear-btn {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .clear-btn:hover {
      background: linear-gradient(135deg, #7f8c8d, #95a5a6);
      transform: translateY(-2px);
    }
    
    .date-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .date-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .date-card:hover {
      background: rgba(52, 152, 219, 0.05);
      border-color: #3498db;
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .date-card.selected {
      background: rgba(52, 152, 219, 0.1);
      border-color: #3498db;
      transform: translateY(-3px);
    }
    
    .date-card h4 {
      color: #2c3e50;
      margin-bottom: 12px;
      font-size: 1.3em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .date-card p {
      color: #7f8c8d;
      margin-bottom: 5px;
      font-size: 0.95em;
    }
    
    .date-card .highlight {
      color: #3498db;
      font-weight: 600;
    }
    
    .controls-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .search-box {
      flex: 1;
      min-width: 250px;
      padding: 15px 20px;
      border: 2px solid #bdc3c7;
      border-radius: 25px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }
    
    .search-box:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .export-btn {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .export-btn:hover {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(46, 204, 113, 0.3);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    th, td {
      padding: 18px 15px;
      text-align: left;
      border-bottom: 1px solid #ecf0f1;
    }
    
    th {
      background: linear-gradient(135deg, #34495e, #2c3e50);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.9em;
      letter-spacing: 1px;
    }
    
    tr:nth-child(even) {
      background: rgba(52, 152, 219, 0.02);
    }
    
    tr:hover {
      background: rgba(52, 152, 219, 0.08);
    }
    
    .score-badge {
      display: inline-block;
      padding: 6px 15px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9em;
    }
    
    .score-excellent { background: #d5f4e6; color: #27ae60; }
    .score-good { background: #fef9e7; color: #f39c12; }
    .score-needs-improvement { background: #fadbd8; color: #e74c3c; }
    
    .multiple-attempts {
      background: linear-gradient(90deg, rgba(52, 152, 219, 0.05) 0%, rgba(52, 152, 219, 0.02) 100%);
      border-left: 4px solid #3498db;
    }
    
    .attempt-badge {
      background: #3498db;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8em;
      margin-left: 10px;
      font-weight: 500;
    }
    
    .no-results {
      text-align: center;
      padding: 60px;
      color: #7f8c8d;
      font-size: 1.2em;
    }
    
    .no-results::before {
      content: "üìù";
      font-size: 3em;
      display: block;
      margin-bottom: 15px;
    }
    
    .hidden { display: none; }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .results-title {
      color: #2c3e50;
      font-size: 1.5em;
      font-weight: 600;
    }
    
    .results-count {
      background: rgba(52, 152, 219, 0.1);
      color: #3498db;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .date-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .controls-section {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-box {
        min-width: auto;
      }
      
      table {
        font-size: 0.9em;
      }
      
      th, td {
        padding: 12px 8px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>üìä Quiz Results Dashboard</h1>
    <p>Advanced student performance tracking with date-based filtering</p>
  </header>

  <div class="container">
    <div id="loadingArea" class="loading">
      Loading quiz results from Firebase...
    </div>

    <div id="errorArea" class="error hidden">
      ‚ùå Unable to connect to Firebase. Please check your configuration.
    </div>

    <div id="mainContent" class="hidden">
      <!-- Statistics Overview -->
      <div id="statsArea">
        <h2>üìà Overview Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <h3 id="totalStudents">0</h3>
            <p>Unique Students</p>
          </div>
          <div class="stat-card">
            <h3 id="totalAttempts">0</h3>
            <p>Total Attempts</p>
          </div>
          <div class="stat-card">
            <h3 id="averageScore">0%</h3>
            <p>Average Score</p>
          </div>
          <div class="stat-card">
            <h3 id="multipleAttempts">0</h3>
            <p>Multiple Attempts</p>
          </div>
        </div>
      </div>

      <!-- Date Filter -->
      <div class="date-filter">
        <h3>üóìÔ∏è Filter by Date Range</h3>
        <div class="date-controls">
          <input type="date" id="startDate" class="date-input" title="Start Date">
          <span>to</span>
          <input type="date" id="endDate" class="date-input" title="End Date">
          <button id="filterBtn" class="filter-btn">Apply Filter</button>
          <button id="clearFilterBtn" class="clear-btn">Clear Filter</button>
        </div>
      </div>

      <!-- Available Dates -->
      <div id="datesArea">
        <h2>üìÖ Available Quiz Dates</h2>
        <div id="dateGrid" class="date-grid"></div>
      </div>

      <!-- Results Table -->
      <div id="resultsArea" class="hidden">
        <div class="results-header">
          <div class="results-title">
            üìã Results for <span id="selectedDateRange"></span>
          </div>
          <div class="results-count" id="resultsCount">0 results</div>
        </div>
        
        <div class="controls-section">
          <input type="text" id="searchBox" class="search-box" placeholder="üîç Search by student name...">
          <button id="exportBtn" class="export-btn">
            üì• Export to CSV
          </button>
        </div>
        
        <div id="tableContainer">
          <table id="resultsTable">
            <thead>
              <tr>
                <th>Student Name</th>
                <th>Attempts</th>
                <th>Section A</th>
                <th>Section B</th>
                <th>Total Score</th>
                <th>Percentage</th>
                <th>Date & Time</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        
        <div id="noResults" class="no-results hidden">
          No quiz results found for the selected criteria.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Firebase configuration - Update with your actual config
    const firebaseConfig = {
      apiKey: "AIzaSyDgqz8...yourapikey...",
      authDomain: "yourapp.firebaseapp.com",
      databaseURL: "https://yourapp.firebaseio.com",
      projectId: "yourapp",
      storageBucket: "yourapp.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abc123"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM elements
    const loadingArea = document.getElementById("loadingArea");
    const errorArea = document.getElementById("errorArea");
    const mainContent = document.getElementById("mainContent");
    const dateGrid = document.getElementById("dateGrid");
    const resultsTable = document.getElementById("resultsTable").querySelector("tbody");
    const selectedDateRange = document.getElementById("selectedDateRange");
    const searchBox = document.getElementById("searchBox");
    const exportBtn = document.getElementById("exportBtn");
    const startDate = document.getElementById("startDate");
    const endDate = document.getElementById("endDate");
    const filterBtn = document.getElementById("filterBtn");
    const clearFilterBtn = document.getElementById("clearFilterBtn");
    const resultsArea = document.getElementById("resultsArea");
    const datesArea = document.getElementById("datesArea");
    const resultsCount = document.getElementById("resultsCount");
    const noResults = document.getElementById("noResults");
    const tableContainer = document.getElementById("tableContainer");

    let allResults = [];
    let filteredResults = [];
    let currentDisplayResults = [];
    let studentStats = {};
    let dateStats = {};

    // Initialize date inputs with current date
    const today = new Date();
    const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    endDate.value = today.toISOString().split('T')[0];
    startDate.value = oneWeekAgo.toISOString().split('T')[0];

    // Fetch quiz results from Firebase
    const quizRef = ref(db, "quizResults");
    
    onValue(quizRef, (snapshot) => {
      loadingArea.classList.add("hidden");
      
      const data = snapshot.val();
      if (!data) {
        showError("üìù No quiz results found yet. Students need to take the quiz first.");
        return;
      }

      try {
        processResults(data);
        showMainContent();
      } catch (error) {
        console.error("Error processing results:", error);
        showError(`‚ùå Error processing quiz data: ${error.message}`);
      }
    }, (error) => {
      loadingArea.classList.add("hidden");
      showError(`‚ùå Firebase connection error: ${error.message}`);
    });

    function showError(message) {
      errorArea.innerHTML = message;
      errorArea.classList.remove("hidden");
    }

    function showMainContent() {
      errorArea.classList.add("hidden");
      mainContent.classList.remove("hidden");
    }

    function processResults(data) {
      allResults = [];
      studentStats = {};
      dateStats = {};
      
      // Convert Firebase data to array
      Object.entries(data).forEach(([key, entry]) => {
        if (!entry.date || !entry.name) return;
        
        // Ensure we have a proper date
        const entryDate = new Date(entry.date);
        if (isNaN(entryDate.getTime())) return;
        
        const result = {
          id: key,
          name: entry.name,
          sectionA: entry.sectionA || 0,
          sectionB: entry.sectionB || 0,
          total: entry.total || 0,
          percentage: Math.round((entry.total || 0) / 26 * 100),
          date: entryDate,
          dateString: entryDate.toLocaleDateString(),
          timeString: entryDate.toLocaleTimeString(),
          ...entry
        };
        
        allResults.push(result);
        
        // Track student statistics
        if (!studentStats[result.name]) {
          studentStats[result.name] = {
            attempts: 0,
            scores: [],
            bestScore: 0,
            latestAttempt: null
          };
        }
        
        studentStats[result.name].attempts++;
        studentStats[result.name].scores.push(result.percentage);
        studentStats[result.name].bestScore = Math.max(studentStats[result.name].bestScore, result.percentage);
        
        if (!studentStats[result.name].latestAttempt || result.date > studentStats[result.name].latestAttempt) {
          studentStats[result.name].latestAttempt = result.date;
        }
        
        // Track date statistics
        if (!dateStats[result.dateString]) {
          dateStats[result.dateString] = {
            count: 0,
            students: new Set(),
            totalScore: 0,
            date: result.date
          };
        }
        
        dateStats[result.dateString].count++;
        dateStats[result.dateString].students.add(result.name);
        dateStats[result.dateString].totalScore += result.percentage;
      });
      
      // Sort results by date (newest first)
      allResults.sort((a, b) => b.date - a.date);
      
      updateOverallStats();
      displayAvailableDates();
      applyDateFilter(); // Apply initial filter
    }

    function updateOverallStats() {
      const uniqueStudents = Object.keys(studentStats).length;
      const totalAttempts = allResults.length;
      const averageScore = totalAttempts > 0 ? 
        Math.round(allResults.reduce((sum, r) => sum + r.percentage, 0) / totalAttempts) : 0;
      const multipleAttempts = Object.values(studentStats).filter(s => s.attempts > 1).length;

      document.getElementById("totalStudents").textContent = uniqueStudents;
      document.getElementById("totalAttempts").textContent = totalAttempts;
      document.getElementById("averageScore").textContent = averageScore + "%";
      document.getElementById("multipleAttempts").textContent = multipleAttempts;
    }

    function displayAvailableDates() {
      dateGrid.innerHTML = "";
      
      // Sort dates by most recent first
      const sortedDates = Object.entries(dateStats)
        .sort(([,a], [,b]) => b.date - a.date);
      
      sortedDates.forEach(([dateString, stats]) => {
        const avgScore = Math.round(stats.totalScore / stats.count);
        
        const card = document.createElement("div");
        card.className = "date-card";
        card.innerHTML = `
          <h4>üìÖ ${dateString}</h4>
          <p><span class="highlight">${stats.count}</span> total attempts</p>
          <p><span class="highlight">${stats.students.size}</span> unique students</p>
          <p>Average: <span class="highlight">${avgScore}%</span></p>
        `;
        
        card.onclick = () => showResultsForDate(dateString);
        dateGrid.appendChild(card);
      });
    }

    function applyDateFilter() {
      const start = startDate.value ? new Date(startDate.value) : null;
      const end = endDate.value ? new Date(endDate.value + 'T23:59:59') : null;
      
      if (start || end) {
        filteredResults = allResults.filter(result => {
          const resultDate = result.date;
          if (start && resultDate < start) return false;
          if (end && resultDate > end) return false;
          return true;
        });
        
        const startStr = start ? start.toLocaleDateString() : 'Beginning';
        const endStr = end ? end.toLocaleDateString() : 'End';
        selectedDateRange.textContent = `${startStr} - ${endStr}`;
      } else {
        filteredResults = [...allResults];
        selectedDateRange.textContent = "All Dates";
      }
      
      currentDisplayResults = filteredResults;
      displayResults(filteredResults);
      showResultsView();
    }

    function showResultsForDate(dateString) {
      filteredResults = allResults.filter(r => r.dateString === dateString);
      currentDisplayResults = filteredResults;
      selectedDateRange.textContent = dateString;
      displayResults(filteredResults);
      showResultsView();
    }

    function showResultsView() {
      datesArea.classList.add("hidden");
      resultsArea.classList.remove("hidden");
    }

    function displayResults(results) {
      resultsTable.innerHTML = "";
      resultsCount.textContent = `${results.length} result${results.length !== 1 ? 's' : ''}`;
      
      if (results.length === 0) {
        tableContainer.classList.add("hidden");
        noResults.classList.remove("hidden");
        return;
      }
      
      tableContainer.classList.remove("hidden");
      noResults.classList.add("hidden");

      // Group by student for multiple attempts display
      const studentGroups = {};
      results.forEach(r => {
        if (!studentGroups[r.name]) {
          studentGroups[r.name] = [];
        }
        studentGroups[r.name].push(r);
      });

      // Display results
      Object.keys(studentGroups)
        .sort()
        .forEach(studentName => {
          const attempts = studentGroups[studentName].sort((a, b) => b.date - a.date);
          
          attempts.forEach((result, index) => {
            const row = document.createElement("tr");
            
            let scoreClass = "score-needs-improvement";
            if (result.percentage >= 80) scoreClass = "score-excellent";
            else if (result.percentage >= 60) scoreClass = "score-good";
            
            if (attempts.length > 1) {
              row.classList.add("multiple-attempts");
            }
            
            const attemptNumber = attempts.length - index;
            const isLatest = index === 0;
            
            row.innerHTML = `
              <td>
                <strong>${result.name}</strong>
                ${attempts.length > 1 ? `<span class="attempt-badge">Attempt ${attemptNumber}${isLatest ? ' (Latest)' : ''}</span>` : ''}
              </td>
              <td>${studentStats[result.name].attempts}</td>
              <td>${result.sectionA}/20</td>
              <td>${result.sectionB}/6</td>
              <td>${result.total}/26</td>
              <td><span class="score-badge ${scoreClass}">${result.percentage}%</span></td>
              <td>
                <div>${result.dateString}</div>
                <div style="font-size: 0.9em; color: #7f8c8d;">${result.timeString}</div>
              </td>
            `;
            
            resultsTable.appendChild(row);
          });
        });
    }

    // Event listeners
    filterBtn.addEventListener("click", applyDateFilter);
    
    clearFilterBtn.addEventListener("click", () => {
      startDate.value = "";
      endDate.value = "";
      resultsArea.classList.add("hidden");
      datesArea.classList.remove("hidden");
      displayAvailableDates();
    });

    searchBox.addEventListener("input", (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const searchResults = currentDisplayResults.filter(r => 
        r.name.toLowerCase().includes(searchTerm)
      );
      displayResults(searchResults);
    });

    exportBtn.addEventListener("click", () => {
      const csvContent = "data:text/csv;charset=utf-8," +
        "Student Name,Attempt Number,Section A,Section B,Total Score,Percentage,Date,Time\n" +
        currentDisplayResults.map(r => {
          const studentAttempts = studentStats[r.name] ? studentStats[r.name].attempts : 1;
          return `"${r.name}",${studentAttempts},"${r.sectionA}/20","${r.sectionB}/6","${r.total}/26",${r.percentage}%,"${r.dateString}","${r.timeString}"`;
        }).join("\n");

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `quiz_results_${selectedDateRange.textContent.replace(/[\/\s]/g, '_')}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
